#!/usr/bin/env ruby

require 'nokogiri'
require 'open-uri'
require 'json'

unless ARGV[0] && %w(radio4 6music all).include?(ARGV[0])
  puts "Usage: nowon [6music|radio4|all]"
  exit
end

def nowon(station)
  case station
  when '6music'
    json = JSON.load(open('http://polling.bbc.co.uk/6music/richtracks.json'))
    doc = Nokogiri::HTML(json['body'])

    artist = doc.css('.richtrack__trackname')[0].inner_text.strip
    track = doc.css('.richtrack__artistname')[0].inner_text.strip

    puts "#{artist} - #{track}"
  when 'radio4'
    doc = Nokogiri::HTML(open('http://www.bbc.co.uk/radio4'))

    text1 = doc.css('.t1-live-title .titling-title-inline-1').text.strip
    text2 = doc.css('.t1-live-title .titling-title-inline-2').text.strip
    synopsis = doc.css('.t1-live-synopsis').text.strip

    puts "#{text1} #{text2}"
    puts synopsis
  end
end

case ARGV[0]
when 'radio4', '6music'
  nowon(ARGV[0])
when 'all'
  station = 'radio4'
  puts station
  nowon(station)
  puts
  station = '6music'
  puts station
  nowon(station)
end
